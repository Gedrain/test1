<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#05000a">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>NekoCore v53 (PB)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;800&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <style id="theme-style"></style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script src="functions/pocketbase.js"></script>
</head>
<body>
    <div id="toast-container"></div>
    <div id="bg-canvas"></div> 

    <div id="loader">
        <div id="boot-log" class="terminal-container"></div>
        <div id="glitch-logo" class="glitch-logo-container">
            <div class="glitch-text" data-text="NEKOCHAT">NEKOCHAT</div>
        </div>
    </div>

    <script>
        const BootLoader = {
            logs: [
                "[ OK ] Started Show Plymouth Boot Screen.",
                "[ OK ] Reached target Paths.",
                "[ OK ] Reached target Basic System.",
                "[ ERRO ] Failed to start Network Name Resolution.",
                "[ ERRO ] Kernel Panic - not syncing: VFS: Unable to mount root fs",
                "[ WARN ] CPU0: Temperature above threshold",
                "Loading kernel modules...",
                "Applying power management settings...",
                "[ FAIL ] Failed to load module: nvidia_drm",
                "Segmentation fault (core dumped)",
                "CORRUPTION DETECTED AT ADDRESS 0x0000F",
                "INITIALIZING NEKO PROTOCOL...",
                "BYPASSING SECURITY LAYER...",
                "ACCESS GRANTED."
            ],
            
            run: () => {
                const term = document.getElementById('boot-log');
                const logo = document.getElementById('glitch-logo');
                const text = logo.querySelector('.glitch-text');
                let i = 0;

                const interval = setInterval(() => {
                    if (i >= BootLoader.logs.length) {
                        clearInterval(interval);
                        setTimeout(() => {
                            term.style.display = 'none';
                            logo.style.opacity = '1';
                            setTimeout(() => {
                                text.classList.add('glitch-out');
                                setTimeout(() => {
                                    document.getElementById('loader').classList.add('hidden');
                                }, 400); 
                            }, 1500); 
                        }, 200);
                        return;
                    }

                    const p = document.createElement('p');
                    p.className = 'log-line';
                    const txt = BootLoader.logs[i];
                    
                    if (txt.includes('[ ERRO ]') || txt.includes('[ FAIL ]') || txt.includes('fault') || txt.includes('CORRUPTION')) {
                        p.classList.add('log-err');
                    } else if (txt.includes('[ WARN ]')) {
                        p.classList.add('log-warn');
                    }
                    
                    p.innerText = txt;
                    term.appendChild(p);
                    i++;
                }, 100); 
            }
        };
        window.addEventListener('load', BootLoader.run);
    </script>

    <div id="app-root">
        <div id="view-auth" class="modal-box hidden">
            <h1 style="font-family:'Exo 2'; color:#d600ff;">NEKO ID</h1>
            <input type="email" id="auth-email" placeholder="E-mail">
            <input type="password" id="auth-pass" placeholder="Password">
            <input type="text" id="auth-nick" placeholder="Codename" style="display:none;">
            <button class="btn-solid" onclick="Auth.submit()" style="margin-top:15px;">LOGIN</button>
            <div style="margin-top:15px; display:flex; justify-content:space-between; font-size:0.8rem; color:#666;">
                <span onclick="Auth.toggle()" style="cursor:pointer;">Register</span>
                <span onclick="Auth.reset()" style="cursor:pointer;">Reset</span>
            </div>
        </div>

        <div id="view-main" class="hidden">
            <div id="sidebar-overlay" class="sidebar-overlay" onclick="UI.toggleMenu()"></div>

            <div id="sidebar" class="sidebar">
                <div class="sidebar-header"><span class="accent-text">NEKO</span>CORE</div>
                <div class="nav-group">
                    <div class="nav-item active" onclick="Route('channels')"><i class="fas fa-hashtag"></i> CHANNELS</div>
                    <div class="nav-item" id="nav-dms" onclick="Route('dms')"><i class="fas fa-comments"></i> <span>MESSAGES</span></div>
                    <div class="nav-item" onclick="Route('search')"><i class="fas fa-search"></i> SEARCH</div>
                </div>
                <div class="nav-group bottom">
                    <div id="nav-admin" class="nav-item hidden" onclick="Route('admin')"><i class="fas fa-shield-alt" style="color:#ff0055"></i> ADMIN</div>
                    <div class="nav-item" onclick="Route('settings')"><i class="fas fa-cog"></i> SETTINGS</div>
                    <div class="nav-item" onclick="Auth.logout()"><i class="fas fa-power-off"></i> EXIT</div>
                </div>
            </div>

            <div class="content-wrapper">
                <div id="tab-channels" class="tab-pane active">
                    <div class="top-bar"><div class="menu-trigger" onclick="UI.toggleMenu()">&#9776;</div><div class="top-title">CHANNELS</div><div style="display:flex; justify-content:center; align-items:center;"><i class="fas fa-plus" style="cursor:pointer; color:var(--accent, #d600ff); font-size:1.2rem;" onclick="document.getElementById('modal-create').classList.add('open')"></i></div></div>
                    <div id="channel-list" class="list-container"></div>
                </div>
                
                <div id="tab-chat" class="tab-pane">
                    <div class="top-bar">
                        <div class="menu-trigger" style="font-size:1.2rem;" onclick="Chat.back()"><i class="fas fa-arrow-left"></i></div>
                        <div class="top-title" id="chat-title">CHAT</div>
                        <div id="chat-top-right" style="width:60px; display:flex; justify-content:center; align-items:center;"></div>
                    </div>
                    <div id="chat-feed" class="messages-container"></div>
                    <div class="chat-input-area"><label for="file-in" style="cursor:pointer; color:#888;"><i class="fas fa-paperclip"></i></label><input type="file" id="file-in" hidden multiple accept="image/*"><input type="text" id="msg-in" placeholder="Message..."><button class="btn-solid" style="width:50px;" onclick="Chat.send()"><i class="fas fa-paper-plane"></i></button></div>
                </div>

                <div id="tab-dms" class="tab-pane"><div class="top-bar"><div class="menu-trigger" onclick="UI.toggleMenu()">&#9776;</div><div class="top-title">MESSAGES</div><div></div></div><div id="dm-list" class="list-container"></div></div>
                
                <div id="tab-search" class="tab-pane"><div class="top-bar"><div class="menu-trigger" onclick="UI.toggleMenu()">&#9776;</div><div class="top-title">SEARCH</div><div></div></div><div style="padding:20px;"><input type="text" id="search-in" placeholder="Search..." oninput="Search.run()"></div><div id="search-results" class="list-container"></div></div>

                <div id="tab-settings" class="tab-pane">
                    <div class="top-bar"><div class="menu-trigger" onclick="UI.toggleMenu()">&#9776;</div><div class="top-title">SETTINGS</div><div></div></div>
                    <div class="admin-scroll-area"> 
                        <div class="p-20 flex-col" style="gap:25px;">
                            <div>
                                <h4 style="color:#666; margin-bottom:10px; text-transform:uppercase; font-size:0.8rem;">Identity</h4>
                                <div style="background:#0e0e12; border:1px solid #333; border-radius:16px; overflow:hidden;" class="panel-box">
                                    <div id="my-banner-prev" style="height:120px; background:#222; background-size:cover; background-position:center;"></div>
                                    <div style="padding:0 20px 20px 20px; text-align:center; margin-top:-40px;">
                                        <img id="my-avi" style="width:80px; height:80px; border-radius:50%; border:4px solid #0e0e12; object-fit:cover; background:#000;" class="panel-border">
                                        <div id="my-id-badge" style="color:#666; font-family:monospace; margin-top:5px;">ID: ???</div>
                                    </div>
                                </div>
                                <div class="file-grid" style="margin-top:15px;">
                                    <label class="file-zone" for="avi-in"><i class="fas fa-user"></i><span>Avatar</span></label>
                                    <label class="file-zone" for="banner-in"><i class="fas fa-image"></i><span>Banner</span></label>
                                </div>
                                <input type="file" id="avi-in" hidden accept="image/*">
                                <input type="file" id="banner-in" hidden accept="image/*">
                                <input type="text" id="my-nick" placeholder="Codename" style="margin-top:10px;">
                                <textarea id="my-bio" rows="3" placeholder="Bio..." style="margin-top:10px;"></textarea>
                                <div style="margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                                    <label style="font-size:0.8rem; color:#888;">Custom Prefix</label>
                                    <div style="display:flex; gap:10px; margin-top:5px;">
                                        <input type="text" id="set-prefix" placeholder="e.g. KING" maxlength="10" style="flex:1;">
                                        <input type="color" id="set-prefix-color" value="#ffffff" style="width:50px; height:40px; padding:0; border:none; background:none;">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 style="color:#666; margin-bottom:10px; text-transform:uppercase; font-size:0.8rem;">Appearance</h4>
                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    <div class="setting-row"><span>Accent Color</span><input type="color" id="set-accent" value="#d600ff" oninput="Settings.previewTheme()"></div>
                                    <div class="setting-row"><span>Background</span><input type="color" id="set-bg" value="#05000a" oninput="Settings.previewTheme()"></div>
                                    <div class="setting-row"><span>Panel / Sidebar</span><input type="color" id="set-panel" value="#0e0e12" oninput="Settings.previewTheme()"></div>
                                    <button class="btn-text" onclick="Settings.resetTheme()" style="align-self:flex-start; margin-top:5px; color:#666;">Reset to Default</button>
                                </div>
                            </div>
                            <div><h4 style="color:#666; margin-bottom:10px; text-transform:uppercase; font-size:0.8rem;">Notifications</h4><button class="btn-solid" onclick="UI.notify('System', 'Test notification', 'info')">TEST NOTIFICATION</button></div>
                            <button class="btn-solid" onclick="Settings.save()">SAVE CHANGES</button>
                        </div>
                    </div>
                </div>

                <div id="tab-admin" class="tab-pane"><div class="top-bar"><div class="menu-trigger" onclick="UI.toggleMenu()">&#9776;</div><div class="top-title text-danger">ROOT</div><div></div></div><div class="admin-scroll-area"><div id="super-admin-controls" class="hidden mb-20"></div><div id="admin-list" class="admin-grid"></div></div></div>
            </div>
        </div>
    </div>

    <div id="modal-members" class="modal-overlay">
        <div class="modal-box" style="height: 80vh; display:flex; flex-direction:column; padding:0; overflow:hidden;">
            <div class="neko-card-header" style="padding:15px; border-bottom:1px solid #333;"><span>CHANNEL MEMBERS</span><i class="fas fa-users" style="color:var(--primary)"></i></div>
            <div id="members-list" class="list-container" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
            <div style="padding:15px; border-top:1px solid #333; background:#09090b;"><button class="btn-text" onclick="document.getElementById('modal-members').classList.remove('open')">CLOSE</button></div>
        </div>
    </div>

    <div id="modal-user" class="modal-overlay">
        <div class="modal-content profile-card-modal">
            <div class="neko-card-header"><span>NEKOID ACCESS CARD</span><i class="fas fa-microchip"></i></div>
            <div id="u-banner" class="p-banner"></div>
            <div class="p-content-grid">
                <div class="p-left-col"><div class="p-avi-wrapper"><img id="u-avi" class="p-avi"><div id="u-status-indicator" class="p-status-dot"></div></div><div id="u-id" class="p-id-chip">ID: ???</div></div>
                <div class="p-right-col"><div class="p-main-info"><div id="u-name" class="p-name">Username</div><div id="u-prefix-container"></div></div><div class="p-stats-grid"><div class="p-stat-row"><span class="p-label">ROLE</span><span id="u-role" class="p-value role-badge">USER</span></div><div class="p-stat-row"><span class="p-label">JOINED</span><span id="u-reg-date" class="p-value">Unknown</span></div><div class="p-stat-row"><span class="p-label">SEEN</span><span id="u-last-seen" class="p-value">Now</span></div></div></div>
            </div>
            <div class="p-badges-section"><div class="p-label-small">ACHIEVEMENTS</div><div id="u-badges" class="p-badges-list"></div></div>
            <div class="p-footer-actions">
                <button class="btn-solid" onclick="Chat.startDM()">MESSAGE</button>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;"><button class="btn-danger" id="btn-block" onclick="Block.toggle()">BLOCK</button><button class="btn-text" style="margin:0; background:#111; border:1px solid #333; color:#ccc; border-radius:10px;" onclick="document.getElementById('modal-user').classList.remove('open')">CLOSE</button></div>
            </div>
        </div>
    </div>

    <div id="modal-cropper" class="modal-overlay"><div class="modal-box"><div class="crop-area"><img id="crop-img" style="display:block; max-width:100%;"></div><div class="crop-controls"><button class="btn-danger" onclick="UI.Crop.cancel()">CANCEL</button><button class="btn-solid" onclick="UI.Crop.finish()">APPLY</button></div></div></div>

    <div id="modal-create" class="modal-overlay">
        <div class="modal-box">
            <h3>NEW CHANNEL</h3>
            <div class="ch-preview-box"><div id="new-ch-banner-prev" class="ch-preview-banner"></div><img id="new-ch-avi-prev" class="ch-preview-avi" src="https://via.placeholder.com/100/000000/ffffff?text=+"></div>
            <div class="file-grid"><label class="file-zone" for="new-ch-avi"><i class="fas fa-icons"></i><span>Icon</span></label><label class="file-zone" for="new-ch-banner"><i class="fas fa-panorama"></i><span>Banner</span></label></div>
            <input type="file" id="new-ch-avi" hidden accept="image/*"><input type="file" id="new-ch-banner" hidden accept="image/*"><input type="text" id="new-ch-name" placeholder="Name"><label class="toggle-wrapper"><input type="checkbox" id="new-ch-priv" class="toggle-checkbox"><div class="toggle-switch"></div><div class="toggle-label">Private Channel</div></label><input type="password" id="new-ch-pass" class="hidden" placeholder="Password">
            <div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-solid" onclick="Channels.create()">CREATE</button><button class="btn-danger" onclick="document.getElementById('modal-create').classList.remove('open')">CANCEL</button></div>
        </div>
    </div>

    <div id="modal-channel-settings" class="modal-overlay">
        <div class="modal-box">
            <h3>CHANNEL SETTINGS</h3>
            <div class="ch-preview-box"><div id="edit-ch-banner-prev" class="ch-preview-banner"></div><img id="edit-ch-avi-prev" class="ch-preview-avi" src="https://via.placeholder.com/100/000000/ffffff?text=+"></div>
            <div class="file-grid"><label class="file-zone" for="edit-ch-avi"><i class="fas fa-icons"></i><span>Icon</span></label><label class="file-zone" for="edit-ch-banner"><i class="fas fa-panorama"></i><span>Banner</span></label></div>
            <input type="file" id="edit-ch-avi" hidden accept="image/*"><input type="file" id="edit-ch-banner" hidden accept="image/*"><input type="text" id="edit-ch-name" placeholder="Channel Name">
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button class="btn-solid" onclick="Channels.saveSettings()">SAVE</button>
                <button class="btn-danger" style="background:rgba(255,153,0,0.1); border-color:#ff9900; color:#ff9900;" onclick="Channels.leaveFromSettings()">LEAVE CHANNEL</button>
                <button class="btn-danger" onclick="Channels.del()">DELETE CHANNEL</button>
                <button class="btn-text" onclick="document.getElementById('modal-channel-settings').classList.remove('open')">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="modal-pass" class="modal-overlay"><div class="modal-box"><h3>ACCESS</h3><input type="password" id="ch-auth-pass"><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-solid" onclick="Channels.auth()">ENTER</button><button class="btn-danger" onclick="document.getElementById('modal-pass').classList.remove('open')">X</button></div></div></div>
    <div id="modal-edit" class="modal-overlay"><div class="modal-box"><h3>EDIT</h3><textarea id="edit-text" rows="3"></textarea><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-solid" onclick="Chat.confirmEdit()">SAVE</button><button class="btn-danger" onclick="document.getElementById('modal-edit').classList.remove('open')">X</button></div></div></div>
    <div id="modal-img" class="modal-overlay" onclick="this.classList.remove('open')"><img id="full-img" style="max-width:95%; max-height:90%; border-radius:12px; border:2px solid #d600ff;"></div>
    <div id="custom-alert" class="modal-overlay"><div class="modal-box"><h3 id="alert-title"></h3><p id="alert-text" style="color:#aaa;"></p><button class="btn-solid" style="margin-top:20px;" onclick="document.getElementById('custom-alert').classList.remove('open')">OK</button></div></div>
    <div id="custom-confirm" class="modal-overlay"><div class="modal-box"><h3 id="confirm-title"></h3><p id="confirm-text" style="color:#aaa;"></p><div style="display:flex; gap:10px; margin-top:20px;"><button id="btn-confirm-yes" class="btn-solid">YES</button><button class="btn-danger" onclick="UI.closeConfirm()">NO</button></div></div></div>

    <script src="functions/config.js"></script>
    <script src="functions/state.js"></script>
    <script src="functions/utils.js"></script>
    <script src="functions/ui.js"></script>
    <script src="functions/profile.js"></script>
    <script src="functions/chat.js"></script>
    <script src="functions/channels.js"></script>
    <script src="functions/search.js"></script>
    <script src="functions/admin.js"></script>
    <script src="functions/auth.js"></script>
    <script src="functions/main.js"></script>
    
    <script>
        document.getElementById('new-ch-priv').onchange = e => document.getElementById('new-ch-pass').classList.toggle('hidden', !e.target.checked);
        
        // PWA SERVICE WORKER
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    refreshing = true;
                    window.location.reload(); 
                });
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('New update available.');
                            }
                        });
                    });
                }).catch(err => console.log('SW Error', err));
            });
        }
    </script>
</body>
</html>